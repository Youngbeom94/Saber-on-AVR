#include "poly.h"
#include "cbd.h"
#include "fips202.h"
#include "pack_unpack.h"

#define h1 (1 << (SABER_EQ - SABER_EP - 1))
#define h2 ((1 << (SABER_EP - 2)) - (1 << (SABER_EP - SABER_ET - 1)) + (1 << (SABER_EQ - SABER_EP - 1)))
#define MAX(a,b) (((a)>(b))?(a):(b))

#define N (256)
#define Q (26017793)
#define RmodQ (2031451)
#define Qprime (26017791)
#define RmodQhi (335348029)
#define omegaQ (397)
#define omegainvQ (-65536)
#define RsqrmodQ (6946499)
#define INV256 (-101632)

__flash
static
int32_t streamlined_CT_table[N << 1] = {
12468715, 2058311524, -9505664, -1569176756, -9735085, -1607049134, 4638815, 765766670, 10625597, 1754053144, -9136174, -1508182056, 7110376, 1173767213, 10929114, 1804157148, -7784561, -1285060378, -10444142, -1724098901, 8039860, 1327204647, -3390925, -559767386, -2718795, -448813457, -7746019, -1278697939, 9647706, 1592624776, -7650810, -1262981020, 3675137, 606684557, 1446934, 238857086, -6459008, -1066240635, -2883401, -475986299, -8309560, -1371726205, -11094930, -1831529734, -741134, -122344977, 6870299, 1134135763, 8600941, 1419826820, -12020096, -1984254361, 7048551, 1163561261, -7177184, -1184795749, -7369413, -1216528544, -9270010, -1530275446, -605137, -99894854, -6395434, -1055745961, 541145, 89331177, 9845685, 1625306769, 9290957, 1533733336, -4399979, -726340082, -3178844, -524757462, 968457, 159871021, 10217802, 1686735129, 9379922, 1548419508, 779735, 128717156, -8676447, -1432291206, -2084786, -344152469, 8161711, 1347319576, 795579, 131332653, 533389, 88050832, 7178475, 1185008865, -7932738, -1309521153, -12195153, -2013152434, 3554747, 586810807, -4380905, -723191383, -4335783, -715742730, 1047651, 172944215, -3320665, -548169000, 4089002, 675004596, -7209882, -1190193473, -10596173, -1749195887, -1623716, -268039919, -10493162, -1732191029, -8259776, -1363507958, 12885567, 2127124651, 6919167, 1142202799, -6946499, -1146714713, 157609, 26017791, 5761559, 951107093, 4376943, 722537344, 10294824, 1699449773, -7007758, -1156827231, 2435542, 402054595, 11505619, 1899325486, -5146905, -849641192, -7274932, -1200931802, 4189852, 691652721, 2951046, 487153006, 9722261, 1604932172, -8812312, -1454719539, 6489555, 1071283275, -9407632, -1552993821, 7418655, 1224657318, 10138881, 1673707002, 541874, 89451519, 3865161, 638053354, 394839, 65179264, 2842122, 469172041, -3795799, -626603208, -4954840, -817935470, 10501964, 1733644046, 12446017, 2054564581, 6659183, 1099285139, 10286831, 1698130304, 7349045, 1213166233, 12810998, 2114814944, 501589, 82801349, -7840175, -1294241030, 6191705, 1022114769, 3379100, 557815338, 2996851, 494714407, -10660734, -1759853493, 5016187, 828062515, 1964411, 324281195, 10215805, 1686405468, -8852218, -1461307145, -5777903, -953805130, 3110445, 513466286, 11217276, 1851726377, 9064857, 1496409183, -2328877, -384446542, -12612507, -2082048431, 10666144, 1760746565, 3417718, 564190323, 8537670, 1409382165, -11878620, -1960899774, -1411302, -232975023, -7034539, -1161248187, -9865511, -1628579607, -1089702, -179885913, 10312081, 1702298525, 7234003, 1194175321, 2783608, 459512662, 10834930, 1788609434, 3884520, 641249101, -1243096, -205207900, 4242387, 700325098, 11254964, 1857947840, 10461102, 1726898625, -12801892, -2113311743, -2031451, -335348029, 397, 65536, 6699185, 1105888593, -1168623, -192914040, 11822412, 1951621066, -5653748, -933309861, 3479543, 574396275, -10587851, -1747822107, 12897628, 2129115658, -6113173, -1009150857, 5646650, 932138136, -9495287, -1567463740, -8364119, -1380732700, 6728011, 1110647133, -12632102, -2085283136, -5069969, -836940745, 5523711, 911843602, 6710211, 1107708744, 2032981, 335600599, 2041352, 336982467, 11535331, 1904230286, 72695, 12000351, 5364391, 885543363, -7680193, -1267831509, -8034475, -1326315701, -4359562, -719668122, 6242694, 1030531935, -10721993, -1769966011, -11646897, -1922647387, 12615182, 2082490015, -11664145, -1925494653, -11685157, -1928963274, -6079252, -1003551244, 10756416, 1775648493, 6692221, 1104738989, 6067995, 1001692960, -6016677, -993221483, -3599532, -594203829, 12870789, 2124685127, -5789466, -955713927, -2308314, -381052042, 3284635, 542221237, -2658721, -438896556, -10200783, -1683925665, 4909334, 810423427, -12024858, -1985040462, 3631347, 599455788, 3613089, 596441792, -12102655, -1997883042, -1144033, -188854770, -2166243, -357599234, 6273737, 1035656454, 3972846, 655829787, -4131513, -682022231, -367241, -60623439, 8603438, 1420239020, 10230628, 1688852420, -365924, -60406031, 8201785, 1353934915, 5829573, 962334714, -2938434, -485071041, -889154, -146779835, -9935122, -1640070857, -10976759, -1812022293, 125955, 20792409, 10535187, 1739128435, -2226861, -367605937, -5545760, -915483409, 2251627, 371694260, 1823925, 301090036, 4251833, 701884425, -11400825, -1882026293, 12084362, 1994863268, -172981, -28555371, -1767508, -291776826, 764577, 126214903, 9104253, 1502912599, -12103602, -1998039371, 591828, 97697830, 11732288, 1936743569, 5195426, 857650945, -7622158, -1258251203, 6981634, 1152514731, -580870, -95888904, 644325, 106363933, 9557335, 1577706505, 2099791, 346629465, 10280788, 1697132737, 6432828, 1061918891, -2311921, -381647478, -10119235, -1670463878, -921594, -152134967, 3578049, 590657457, 12496571, 2062909938, -9011511, -1487602927, 9585685, 1582386469, 12434343, 2052637460, -11422536, -1885610304, -7068631, -1166876029, 8588861, 1417832677, -11943822, -1971663195, -662623, -109384532, -3101123, -511927429, -1928491, -318351590, -4261707, -703514406, 12010394, 1982652773, 4215969, 695964065, 8292795, 1368958671, 12076379, 1993545450, -11749023, -1939506150, -6441091, -1063282931, 3908810, 645258847, 7141900, 1178971135, -6591607, -1088129823, 12104552, 1998196195, -8808132, -1454029513, 12078876, 1993957650, 9690787, 1599736505, 9102656, 1502648969, 9941961, 1641199826, 12345070, 2037900444, 8531365, 1408341348, 7104653, 1172822471, 828955, 136842299, -6928906, -1143810494, -6839688, -1129082558, -9789386, -1616013038, -8881489, -1466139145, 65536, 10818557,
};

__flash
static
int32_t streamlined_CT_inv_table[N << 1] = {
1, 165, 1, 165, -12468715, -2058311524, 1, 165, 9735085, 1607049134, -12468715, -2058311524, 9505664, 1569176756, 1, 165, -7110376, -1173767213, 9735085, 1607049134, -10625597, -1754053144, -12468715, -2058311524, 9136174, 1508182056, 9505664, 1569176756, -4638815, -765766670, 1, 165, -9647706, -1592624776, -7110376, -1173767213, -8039860, -1327204647, 9735085, 1607049134, 2718795, 448813457, -10625597, -1754053144, 7784561, 1285060378, -12468715, -2058311524, 7746019, 1278697939, 9136174, 1508182056, 10444142, 1724098901, 9505664, 1569176756, 3390925, 559767386, -4638815, -765766670, -10929114, -1804157148, 1, 165, 605137, 99894854, -9647706, -1592624776, 741134, 122344977, -7110376, -1173767213, -7048551, -1163561261, -8039860, -1327204647, 6459008, 1066240635, 9735085, 1607049134, 7369413, 1216528544, 2718795, 448813457, 8309560, 1371726205, -10625597, -1754053144, -8600941, -1419826820, 7784561, 1285060378, -3675137, -606684557, -12468715, -2058311524, 9270010, 1530275446, 7746019, 1278697939, 11094930, 1831529734, 9136174, 1508182056, 12020096, 1984254361, 10444142, 1724098901, -1446934, -238857086, 9505664, 1569176756, 7177184, 1184795749, 3390925, 559767386, 2883401, 475986299, -4638815, -765766670, -6870299, -1134135763, -10929114, -1804157148, 7650810, 1262981020, 1, 165, 6946499, 1146714713, 605137, 99894854, -7178475, -1185008865, -9647706, -1592624776, -4089002, -675004596, 741134, 122344977, -10217802, -1686735129, -7110376, -1173767213, 10493162, 1732191029, -7048551, -1163561261, 2084786, 344152469, -8039860, -1327204647, 4380905, 723191383, 6459008, 1066240635, -9290957, -1533733336, 9735085, 1607049134, -12885567, -2127124651, 7369413, 1216528544, -795579, -131332653, 2718795, 448813457, -1047651, -172944215, 8309560, 1371726205, 3178844, 524757462, -10625597, -1754053144, 10596173, 1749195887, -8600941, -1419826820, -779735, -128717156, 7784561, 1285060378, 12195153, 2013152434, -3675137, -606684557, -541145, -89331177, -12468715, -2058311524, -6919167, -1142202799, 9270010, 1530275446, -533389, -88050832, 7746019, 1278697939, 3320665, 548169000, 11094930, 1831529734, -968457, -159871021, 9136174, 1508182056, 1623716, 268039919, 12020096, 1984254361, 8676447, 1432291206, 10444142, 1724098901, -3554747, -586810807, -1446934, -238857086, -9845685, -1625306769, 9505664, 1569176756, 8259776, 1363507958, 7177184, 1184795749, -8161711, -1347319576, 3390925, 559767386, 4335783, 715742730, 2883401, 475986299, 4399979, 726340082, -4638815, -765766670, 7209882, 1190193473, -6870299, -1134135763, -9379922, -1548419508, -10929114, -1804157148, 7932738, 1309521153, 7650810, 1262981020, 6395434, 1055745961, 1, 165, 2031451, 335348029, 6946499, 1146714713, -6191705, -1022114769, 605137, 99894854, -8537670, -1409382165, -7178475, -1185008865, -7418655, -1224657318, -9647706, -1592624776, -2783608, -459512662, -4089002, -675004596, -10501964, -1733644046, 741134, 122344977, 5777903, 953805130, -10217802, -1686735129, 5146905, 849641192, -7110376, -1173767213, -4242387, -700325098, 10493162, 1732191029, -7349045, -1213166233, -7048551, -1163561261, 2328877, 384446542, 2084786, 344152469, -9722261, -1604932172, -8039860, -1327204647, 9865511, 1628579607, 4380905, 723191383, -394839, -65179264, 6459008, 1066240635, -5016187, -828062515, -9290957, -1533733336, -10294824, -1699449773, 9735085, 1607049134, -10461102, -1726898625, -12885567, -2127124651, -501589, -82801349, 7369413, 1216528544, -10666144, -1760746565, -795579, -131332653, -6489555, -1071283275, 2718795, 448813457, -10312081, -1702298525, -1047651, -172944215, 3795799, 626603208, 8309560, 1371726205, -10215805, -1686405468, 3178844, 524757462, -2435542, -402054595, -10625597, -1754053144, -3884520, -641249101, 10596173, 1749195887, -6659183, -1099285139, -8600941, -1419826820, -11217276, -1851726377, -779735, -128717156, -4189852, -691652721, 7784561, 1285060378, 1411302, 232975023, 12195153, 2013152434, -541874, -89451519, -3675137, -606684557, -2996851, -494714407, -541145, -89331177, -5761559, -951107093, -12468715, -2058311524, 12801892, 2113311743, -6919167, -1142202799, 7840175, 1294241030, 9270010, 1530275446, -3417718, -564190323, -533389, -88050832, 9407632, 1552993821, 7746019, 1278697939, -7234003, -1194175321, 3320665, 548169000, 4954840, 817935470, 11094930, 1831529734, 8852218, 1461307145, -968457, -159871021, -11505619, -1899325486, 9136174, 1508182056, 1243096, 205207900, 1623716, 268039919, -10286831, -1698130304, 12020096, 1984254361, -9064857, -1496409183, 8676447, 1432291206, -2951046, -487153006, 10444142, 1724098901, 7034539, 1161248187, -3554747, -586810807, -3865161, -638053354, -1446934, -238857086, 10660734, 1759853493, -9845685, -1625306769, -4376943, -722537344, 9505664, 1569176756, -11254964, -1857947840, 8259776, 1363507958, -12810998, -2114814944, 7177184, 1184795749, 12612507, 2082048431, -8161711, -1347319576, 8812312, 1454719539, 3390925, 559767386, 1089702, 179885913, 4335783, 715742730, -2842122, -469172041, 2883401, 475986299, -1964411, -324281195, 4399979, 726340082, 7007758, 1156827231, -4638815, -765766670, -10834930, -1788609434, 7209882, 1190193473, -12446017, -2054564581, -6870299, -1134135763, -3110445, -513466286, -9379922, -1548419508, 7274932, 1200931802, -10929114, -1804157148, 11878620, 1960899774, 7932738, 1309521153, -10138881, -1673707002, 7650810, 1262981020, -3379100, -557815338, 6395434, 1055745961, -157609, -26017791,
};

__flash
static
int32_t last_twist_table[N << 1] = {
-101632, -16777215, -256, -42260, -9240577, -1525416703, 304404, 50250428, 6226687, 1027889530, -9093820, -1501190339, 9021062, 1489179588, -2008893, -331624198, 4779068, 788919366, 1191686, 196721236, 7080890, 1168899721, 148908, 24581447, -2162313, -356950477, -9573703, -1580408503, 3121613, 515309878, -123209, -20339105, 9109194, 1503728249, -1877599, -309950437, 12184967, 2011470949, 10123237, 1671124520, -8756325, -1445477313, 6072792, 1002484839, 7683009, 1268296369, 8670105, 1431244281, -1419953, -234403114, -7605753, -1255543097, 1750314, 288938473, 3871033, 639022693, 7480855, 1234925175, -12039781, -1987503923, -2520695, -416111489, 9299763, 1535187014, -2466943, -407238212, -989254, -163304150, -4590012, -757710365, -6696234, -1105401447, 2276893, 375865123, -6416793, -1059271864, 5357789, 884453517, 8074424, 1332910405, 10440563, 1723508087, 9201339, 1518939369, -4564343, -753472976, 2216727, 365933035, 7935440, 1309967194, 12668437, 2091281248, -10912602, -1801431378, -8809312, -1454224305, -7755438, -1280252809, 2798513, 461973151, -3925111, -647949785, -1844895, -304551723, 2354649, 388700934, -2746581, -453400316, 8840442, 1459363186, -2992388, -493977664, -12983666, -2143318646, 11632704, 1920304433, 12481142, 2060362949, 9272015, 1530606427, -5219525, -861629162, 10865829, 1793710181, 4025066, 664450164, 7677851, 1267444896, 8473484, 1398786464, 5526368, 912282215, -8374688, -1382477410, -1790567, -295583361, 6352482, 1048655527, -5554559, -916935931, 8636761, 1425739917, -1682181, -277691209, 6025075, 994607809, 12729161, 2101305449, -9798337, -1617490652, -1335401, -220445432, -7015716, -1158140922, -4474120, -738579136, -4598790, -759159420, -3812672, -629388571, -7611780, -1256538022, 6468891, 1067872101, -11321434, -1868920580, 12095643, 1996725514, 10057476, 1660268821, 8020726, 1324046043, -8827157, -1457170123, -9066203, -1496631378, -5658933, -934165791, 6211666, 1025409893, 12664095, 2090564479, -12551013, -2071897119, -9337727, -1541454038, -7232481, -1193924072, -4278058, -706213598, -928280, -153238679, 6158046, 1016558406, -11715433, -1933961178, -2454342, -405158063, 5760986, 951012504, -7784273, -1285012836, -6769816, -1117548222, 11255140, 1857976893, -12423490, -2050845867, 11044291, 1823170345, -9671509, -1596554130, 12558551, 2073141478, 9665426, 1595549960, -4169958, -688368657, -8530184, -1408146391, -10179567, -1680423368, 5872599, 969437363, -11454008, -1890805641, 10522445, 1737025010, 2647945, 437117675, 2955790, 487936136, -8184555, -1351090619, 175992, 29052421, -7929413, -1308972268, 8630779, 1424752420, 87276, 14407354, 4194524, 692423965, 11675974, 1927447362, 12677859, 2092836613, -3965762, -654660374, 8444155, 1393944889, 2315030, 382160706, -8055097, -1329719941, -2182978, -360361815, -8197499, -1353227390, -10113193, -1669466476, 957566, 158073156, -128660, -21238946, 2096828, 346140339, 8262818, 1364010125, -3714739, -613221979, 646003, 106640934, -5503397, -908490206, 11979226, 1977507620, -9669154, -1596165371, -11689764, -1929723789, 6458619, 1066176419, 11419533, 1885114574, 11300957, 1865540276, 2977586, 491534178, -5628596, -929157817, -4601698, -759639467, 4641465, 766204127, -9032277, -1491030939, 8496929, 1402656719, 4084635, 674283700, 6432817, 1061917075, 11222860, 1852648173, -4362643, -720176727, 644371, 106371527, -2619817, -432474358, 910905, 150370448, -12252938, -2022691471, -4618384, -762393960, 5427855, 896019878, -4639384, -765860600, 2740826, 452450292, 4070136, 671890233, -6019060, -993614864, 9356487, 1544550903, 613392, 101257573, -1767927, -291845993, 5631643, 929660810, -12961943, -2139732654, -7045002, -1162975399, -10503506, -1733898596, 5019815, 828661419, -9621148, -1588240632, -9658027, -1594328547, -12410632, -2048723293, 951779, 157117849, -11138723, -1838758999, 6132327, 1012312763, 8666199, 1430599486, -5614267, -926792413, -7026494, -1159920134, -607523, -100288730, 7404038, 1222244372, 805082, 132901390, 2230252, 368165717, 6166002, 1017871767, -12763989, -2107054788, 2720361, 449071969, -7660860, -1264640055, -3230561, -533294805, 11264055, 1859448565, 1732309, 285966242, -12971765, -2141354051, 12222558, 2017676399, -7767997, -1282326025, -6704239, -1106722897, 6536713, 1079068027, -7061423, -1165686146, -1066363, -176033156, 1373570, 226746297, 3280260, 541499020, 9904199, 1634966148, 10314100, 1702631818, -2595460, -428453552, -8264074, -1364217463, 7974576, 1316427689, -2404745, -396970686, 7596119, 1253952735, 5196478, 857824607, -9489631, -1566530059, 9151137, 1510652119, 7232011, 1193846485, 9062185, 1495968094, 8804651, 1453454876, 1005218, 165939457, -914972, -151041820, -7407873, -1222877447, -9652452, -1593408237, 12493063, 2062330845, 8551149, 1411607253, -10857437, -1792324846, -7629525, -1259467333, -1395474, -230362168, 1241669, 204972334, 9636920, 1590844244, -9281838, -1532227989, -1465172, -241867780, -10161771, -1677485639, 10394628, 1715925225, 1533511, 253149050, 6557463, 1082493397, 12009606, 1982522692, 2717227, 448554614, -10413380, -1719020769, 4561290, 752968992, -10277663, -1696616868, 8297184, 1369683198, 7623076, 1258402744, 7752450, 1279759556, 10898504, 1799104108, -3904708, -644581697, -12068460, -1992238197, 3705153, 611639541, 3155061, 520831410, -6676725, -1102180939, -1393074, -229965980, 62027, 10239298, -6225764, -1027737163, 639678, 105596816, -7272885, -1200593887, -10176400, -1679900566, 6462431, 1066805697, -4243562, -700519064, 1889855, 311973634, -8842600, -1459719424, -11687682, -1929380096,
};

static
int32_t freeze_32(int32_t a)
{

    a %= Q;

    if(a >= Q / 2){
        a -= Q;
    }
    if(a <= -Q / 2){
        a += Q;
    }

    return a;

}

// we assume -Q / 2 < a < Q / 2
int32_t gethi(int32_t a)
{

    int32_t lo, hi;

    int32_t bp_lo, bp_hi;
    int32_t a_lo, a_hi;

    // below we compute lo = a R mod^+- Q
    lo = a * RmodQ;

    bp_lo = (int32_t)(uint16_t)RmodQhi;
    bp_hi = (int32_t)(int16_t)(RmodQhi >> 16);

    a_lo = (int32_t)(uint16_t)a;
    a_hi = (int32_t)(int16_t)(a >> 16);

    hi = a_hi * bp_hi;
    hi += ((a_lo * bp_hi) >> 16);
    hi += ((a_hi * bp_lo) >> 16);

    lo -= hi * Q;

    lo = freeze_32(lo);

    // return (a R mod^+- Q) * Qprime mod^+- R
    // we reduce mod^+- R by typing
    return lo * Qprime;
}

int32_t Barrett_mul_approx(int32_t a, int32_t b, int32_t bp, int32_t q) {

    int32_t lo, hi;

    int32_t bp_lo, bp_hi;
    int32_t a_lo, a_hi;

    lo = a * b;

    bp_lo = (int32_t)(uint16_t)bp;
    bp_hi = (int32_t)(int16_t)(bp >> 16);

    a_lo = (int32_t)(uint16_t)a;
    a_hi = (int32_t)(int16_t)(a >> 16);

    hi = a_hi * bp_hi;
    hi += ((a_lo * bp_hi) >> 16);
    hi += ((a_hi * bp_lo) >> 16);

    return lo - hi * q;

}

void point_mul_on_the_fly(int32_t res[N], int32_t src1[N], int32_t src2[N])
{
    for (int cnt_i = 0; cnt_i < N; cnt_i++)
    {
        res[cnt_i] = Barrett_mul_approx(src1[cnt_i], src2[cnt_i], gethi(src2[cnt_i]), Q);
        res[cnt_i] = freeze_32(res[cnt_i]);
    }
}

void point_mul_pre(int32_t res[N], int32_t src1[N])
{
    for (int cnt_i = 0; cnt_i < N; cnt_i++)
    {
        res[cnt_i] = Barrett_mul_approx(src1[cnt_i], last_twist_table[2 * cnt_i + 0], last_twist_table[2 * cnt_i + 1], Q);
        res[cnt_i] = freeze_32(res[cnt_i]);
    }
}


void barrett_ntt(int32_t a[N])
{
    unsigned int len, start, j, k;
    int32_t zeta, zetap, t;

    k = 0;
    for (len = 128; len > 0; len >>= 1) {
        for (start = 0; start < N; start = j + len)
        {
            zeta = streamlined_CT_table[k++];
            zetap = streamlined_CT_table[k++];
            for (j = start; j < start + len; ++j) {
                //! if we want stream : t = Barrett_mul_approx(a[j + len], zeta, gethi(zeta), Q);
                t = Barrett_mul_approx(a[j + len], zeta, zetap, Q);
                a[j + len] = a[j] - t;
                a[j] = a[j] + t;
            }
        }
    }
}

void barrett_invntt(int32_t a[N])
{
    unsigned int len, i, j, k;
    int32_t t, zeta, zetap;

    k = 0;
    for (len = 1; len < N; len <<= 1)
    {
        for (i = 0; i < len; i++)
        {
            zeta = streamlined_CT_inv_table[k++];
            zetap = streamlined_CT_inv_table[k++];
            for (j = 0; j < N / (len << 1); j++)
            {
                if (zeta == 1) t = a[j * (len << 1) + i + len]; //! do light Butterfly
                else t = Barrett_mul_approx(a[j * (len << 1) + i + len], zeta, zetap, Q); //! do Origin Butterfly
                //! if we want stream : t = Barrett_mul_approx(a[j * (len << 1) + i + len], zeta, gethi(zeta), Q);                
                a[j * (len << 1) + i + len] = a[j * (len << 1) + i] - t;
                a[j * (len << 1) + i] = a[j * (len << 1) + i] + t;
            }
        }
    }
    
    point_mul_pre(a, a);
}


static inline
void polymul(uint16_t des[SABER_N], uint16_t poly1[SABER_N], uint16_t poly2[SABER_N])
{

    int32_t a_tmp[SABER_N] = { 0 };
    int32_t b_tmp[SABER_N] = { 0 };
    int32_t res_tmp[SABER_N] = { 0 };

    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) 
    {
        a_tmp[cnt_i] = (int32_t)(int16_t)poly1[cnt_i];
        b_tmp[cnt_i] = (int32_t)poly2[cnt_i];
    }

    barrett_ntt(a_tmp);
    barrett_ntt(b_tmp);
    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) a_tmp[cnt_i] = freeze_32(a_tmp[cnt_i]);
    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) b_tmp[cnt_i] = freeze_32(b_tmp[cnt_i]);

    point_mul_on_the_fly(res_tmp, a_tmp, b_tmp);
    barrett_invntt(res_tmp);

    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) des[cnt_i] = (uint16_t)((res_tmp[cnt_i] & 8191));
}

static inline
void polymul_dec(uint16_t des[SABER_N], uint16_t poly1[SABER_N], uint16_t poly2[SABER_N])
{

    int32_t a_tmp[SABER_N] = { 0 };
    int32_t b_tmp[SABER_N] = { 0 };
    int32_t res_tmp[SABER_N] = { 0 };

    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) 
    {
        poly1[cnt_i] = poly1[cnt_i] & 8191;
        
        a_tmp[cnt_i] = (int32_t)(int16_t)poly1[cnt_i];

        if(a_tmp[cnt_i] >= 8192/2) a_tmp[cnt_i] -= 8192;
        if(a_tmp[cnt_i] < -8192/2) a_tmp[cnt_i] += 8192;
        b_tmp[cnt_i] = (int32_t)(poly2[cnt_i]);
    }

    barrett_ntt(a_tmp);
    barrett_ntt(b_tmp);
    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) a_tmp[cnt_i] = freeze_32(a_tmp[cnt_i]);
    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) b_tmp[cnt_i] = freeze_32(b_tmp[cnt_i]);

    point_mul_on_the_fly(res_tmp, a_tmp, b_tmp);
    barrett_invntt(res_tmp);

    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) des[cnt_i] = (uint16_t)((res_tmp[cnt_i] & 8191));        
}

static inline
void polymla(uint16_t des[SABER_N], uint16_t poly1[SABER_N], uint16_t poly2[SABER_N])
{

    int32_t a_tmp[SABER_N] = { 0 };
    int32_t b_tmp[SABER_N] = { 0 };
    int32_t res_tmp[SABER_N] = { 0 };

    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) 
    {
        a_tmp[cnt_i] = (int32_t)(int16_t)poly1[cnt_i];
        b_tmp[cnt_i] = (int32_t)poly2[cnt_i];
    }

    barrett_ntt(a_tmp);
    barrett_ntt(b_tmp);
    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) a_tmp[cnt_i] = freeze_32(a_tmp[cnt_i]);
    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) b_tmp[cnt_i] = freeze_32(b_tmp[cnt_i]);

    point_mul_on_the_fly(res_tmp, a_tmp, b_tmp);
    barrett_invntt(res_tmp);

    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) des[cnt_i] = (des[cnt_i]+ (uint16_t)((res_tmp[cnt_i] & 8191))) & 8191;
}

static inline
void polymla_dec(uint16_t des[SABER_N], uint16_t poly1[SABER_N], uint16_t poly2[SABER_N])
{

    int32_t a_tmp[SABER_N] = { 0 };
    int32_t b_tmp[SABER_N] = { 0 };
    int32_t res_tmp[SABER_N] = { 0 };

    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) 
    {
        poly1[cnt_i] = poly1[cnt_i] & 8191;        
        a_tmp[cnt_i] = (int32_t)(int16_t)poly1[cnt_i];
        if(a_tmp[cnt_i] >= 8192/2) a_tmp[cnt_i] -= 8192;
        if(a_tmp[cnt_i] < -8192/2) a_tmp[cnt_i] += 8192;
        b_tmp[cnt_i] = (int32_t)(poly2[cnt_i]);
    }

    barrett_ntt(a_tmp);
    barrett_ntt(b_tmp);
    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) a_tmp[cnt_i] = freeze_32(a_tmp[cnt_i]);
    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) b_tmp[cnt_i] = freeze_32(b_tmp[cnt_i]);

    point_mul_on_the_fly(res_tmp, a_tmp, b_tmp);
    barrett_invntt(res_tmp);

    for (int cnt_i = 0; cnt_i < SABER_N; cnt_i++) des[cnt_i] += (uint16_t)((res_tmp[cnt_i] & 8191));
}

static inline shake128incctx shake128_absorb_seed(const uint8_t seed[SABER_SEEDBYTES])
{

    shake128incctx ctx;
    shake128_inc_init(&ctx);
    shake128_inc_absorb(&ctx, seed, SABER_SEEDBYTES);
    shake128_inc_finalize(&ctx);

    return ctx;
}

void MatrixVectorMulKeyPairNTT_D( uint8_t pk[SABER_INDCPA_PUBLICKEYBYTES], uint8_t sk[SABER_INDCPA_SECRETKEYBYTES])
{

    uint16_t poly[SABER_N];
    uint16_t s_poly[SABER_N];
    uint16_t acc[SABER_L * SABER_N];

    uint8_t shake_out[MAX(SABER_POLYBYTES, SABER_POLYCOINBYTES)];

    uint8_t *seed_A = pk + SABER_POLYVECCOMPRESSEDBYTES;
    uint8_t *seed_s = sk;

    size_t i, j;

    shake128incctx shake_s_ctx = shake128_absorb_seed(seed_s);
    shake128incctx shake_A_ctx = shake128_absorb_seed(seed_A);

    for (i = 0; i < SABER_L; i++) {

        shake128_inc_squeeze(shake_out, SABER_POLYCOINBYTES, &shake_s_ctx);
        cbd(s_poly, shake_out);
#ifdef SABER_COMPRESS_SECRETKEY
        POLmu2BS(sk + i * SABER_POLYSECRETBYTES, s_poly); // sk <- s
#else
        POLq2BS(sk + i * SABER_POLYSECRETBYTES, s_poly);
#endif

        for (j = 0; j < SABER_L; j++) {

            shake128_inc_squeeze(shake_out, SABER_POLYBYTES, &shake_A_ctx);
            BS2POLq(shake_out, poly);

            if (i == 0) {
                polymul(acc + j * SABER_N, s_poly, poly);                
               
            } else {
                polymla(acc + j * SABER_N, s_poly, poly);
            }

        }
    }

    shake128_inc_ctx_release(&shake_A_ctx);
    shake128_inc_ctx_release(&shake_s_ctx);

    for (i = 0; i < SABER_L; i++) {

        for (j = 0; j < SABER_N; j++) {
            poly[j] = ((acc[i * SABER_N + j] + h1) >> (SABER_EQ - SABER_EP));
        }

        POLp2BS(pk + i * SABER_POLYCOMPRESSEDBYTES, poly);
    }

}

uint32_t MatrixVectorMulEncNTT_D(uint8_t ct0[SABER_POLYVECCOMPRESSEDBYTES], uint8_t ct1[SABER_SCALEBYTES_KEM], const uint8_t seed_s[SABER_NOISE_SEEDBYTES], const uint8_t seed_A[SABER_SEEDBYTES], const uint8_t pk[SABER_INDCPA_PUBLICKEYBYTES], const uint8_t m[SABER_KEYBYTES], int compare){

    uint16_t poly[SABER_N];
    uint16_t s_poly[SABER_L * SABER_N];
    uint16_t acc[SABER_N];

    uint8_t shake_out[MAX(SABER_POLYBYTES, SABER_POLYCOINBYTES)];

    uint16_t *mp = poly;

    size_t i, j;
    uint32_t fail = 0;

    shake128incctx shake_s_ctx = shake128_absorb_seed(seed_s);

    for(i = 0; i < SABER_L; i++){
        shake128_inc_squeeze(shake_out, SABER_POLYCOINBYTES, &shake_s_ctx);
        cbd(s_poly + i * SABER_N, shake_out);
    }

    shake128_inc_ctx_release(&shake_s_ctx);

    shake128incctx shake_A_ctx = shake128_absorb_seed(seed_A);

    for (i = 0; i < SABER_L; i++) {

        for (j = 0; j < SABER_L; j++) {

            shake128_inc_squeeze(shake_out, SABER_POLYBYTES, &shake_A_ctx);
            BS2POLq(shake_out, poly);

            if (j == 0) 
            {
                polymul(acc, s_poly + j * SABER_N, poly);
            } 
            else 
            {
                polymla(acc, s_poly + j * SABER_N, poly);
            }

        }

        for (j = 0; j < SABER_N; j++) {
            acc[j] = ((acc[j] + h1) >> (SABER_EQ - SABER_EP));
        }

        if (compare) {
            fail |= POLp2BS_cmp(ct0 + i * SABER_POLYCOMPRESSEDBYTES, acc);
        } else {
            POLp2BS(ct0 + i * SABER_POLYCOMPRESSEDBYTES, acc);
        }
    }

    shake128_inc_ctx_release(&shake_A_ctx);

    for(j = 0; j < SABER_L; j++){

        BS2POLp(pk + j * SABER_POLYCOMPRESSEDBYTES, poly);

        if(j == 0)
        {
            polymul(acc, s_poly + j * SABER_N, poly);
        }
        else
        {
            polymla(acc, s_poly + j * SABER_N, poly);
        }
    }

    BS2POLmsg(m, mp);

    for(j = 0; j < SABER_N; j++){
        acc[j] = (acc[j] - (mp[j] << (SABER_EP - 1)) + h1) >> (SABER_EP - SABER_ET);
    }

    if(compare){
        fail |= POLT2BS_cmp(ct1, acc);
    }else{
        POLT2BS(ct1, acc);
    }

    return fail;

}

void InnerProdDecNTT(uint8_t m[SABER_KEYBYTES], const uint8_t ciphertext[SABER_BYTES_CCA_DEC], const uint8_t sk[SABER_INDCPA_SECRETKEYBYTES]){

    uint16_t poly[SABER_N];
    uint16_t buff[SABER_N];
    uint16_t acc[SABER_N];

    size_t i;

    for (i = 0; i < SABER_L; i++) {

#ifdef SABER_COMPRESS_SECRETKEY
        BS2POLmu(sk + i * SABER_POLYSECRETBYTES, buff);
#else
        BS2POLq(sk + i * SABER_POLYSECRETBYTES, buff);
#endif
        BS2POLp(ciphertext + i * SABER_POLYCOMPRESSEDBYTES, poly);

        if(i == 0)
        {
            polymul_dec(acc, buff, poly);
        }else{
            polymla_dec(acc, buff, poly);
        }

    }

    BS2POLT(ciphertext + SABER_POLYVECCOMPRESSEDBYTES, buff);

    for (i = 0; i < SABER_N; i++) {
        poly[i] = (acc[i] + h2 - (buff[i] << (SABER_EP - SABER_ET))) >> (SABER_EP - 1);
    }

    POLmsg2BS(m, poly);

}




